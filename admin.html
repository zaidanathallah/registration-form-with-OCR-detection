<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Admin</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
      }

      /* Styling untuk modal header */
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        position: relative;
      }

      .modal-header h2 {
        margin: 0;
        color: #333;
        flex-grow: 1;
        text-align: left; /* Ubah ke left */
        border-bottom: none; /* Hapus garis bawah */
        padding-bottom: 0; /* Hapus padding bawah */
      }

      /* Perbaiki tampilan tombol close */
      .modal-header .close {
        font-size: 20px;
        font-weight: bold;
        color: #666;
        cursor: pointer;
        margin-left: 10px;
      }

      /* Hapus CSS yang bertentangan */
      #editModal .close {
        position: relative; /* Ubah ke relative */
        right: auto;
        top: auto;
      }

      /* Perbaiki modal content */
      #editModal .modal-content {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 20px;
        max-width: 500px;
        margin: 20px auto;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
      }

      .form-group input,
      .form-group textarea {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s;
      }

      .form-group input:focus,
      .form-group textarea:focus {
        border-color: #4caf50;
        outline: none;
      }

      .form-group textarea {
        height: 100px;
        resize: vertical;
      }

      .btn-save {
        background-color: #4caf50;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        width: 100%;
        font-size: 16px;
        margin-top: 20px;
        transition: background-color 0.3s;
      }

      .btn-save:hover {
        background-color: #45a049;
      }

      /* Perbaikan modal edit */
      #editModal .modal-content {
        max-width: 500px;
        padding: 25px;
      }

      #editModal h2 {
        margin: 0 0 20px 0;
        color: #333;
        text-align: center;
        padding-bottom: 10px;
      }

      #editModal .close {
        position: absolute;
        right: 15px;

        font-size: 28px;
        font-weight: bold;
        color: #666;
      }

      #editModal .close:hover {
        color: #333;
        text-decoration: none;
      }
      /* Tambahkan setelah CSS yang ada */
      .dropdown {
        position: relative;
        display: inline-block;
      }

      .dropdown-content {
        display: none;
        position: absolute;
        right: 0;
        background-color: #f9f9f9;
        min-width: 160px;
        box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
        z-index: 1;
        border-radius: 4px;
      }

      .dropdown-content button {
        width: 100%;
        padding: 12px 16px;
        text-align: left;
        border: none;
        background: none;
        cursor: pointer;
        color: black;
        display: block;
      }

      .dropdown-content button:hover {
        background-color: #f1f1f1;
      }

      .dropdown:hover .dropdown-content {
        display: block;
      }

      .action-btn {
        background-color: #4caf50;
        color: white;
        padding: 8px;
        border: none;
        cursor: pointer;
        border-radius: 4px;
      }

      .action-btn:hover {
        background-color: #45a049;
      }
      .btn-edit {
        background-color: #2196f3;
        color: white;
        margin-right: 5px;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
      }

      .controls {
        margin-bottom: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .column-toggle {
        display: flex;
        gap: 10px;
      }

      .column-toggle label {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }

      th,
      td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
      }

      th {
        background-color: #4caf50;
        color: white;
      }

      tr:hover {
        background-color: #f5f5f5;
      }

      .actions {
        display: flex;
        gap: 10px;
      }

      button {
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }

      .btn-view {
        background-color: #2196f3;
        color: white;
      }

      .btn-delete {
        background-color: #f44336;
        color: white;
      }

      .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        cursor: pointer;
      }

      .modal-content {
        background-color: white;
        margin: 10% auto;
        padding: 20px;
        width: 80%;
        max-width: 600px;
        border-radius: 8px;
        cursor: auto;
      }

      .close {
        float: right;
        cursor: pointer;
        font-size: 24px;
      }

      #imagePreview {
        max-width: 100%;
        margin-top: 10px;
      }

      /* Tambahkan CSS untuk responsif */
      @media screen and (max-width: 768px) {
        .container {
          padding: 10px;
          margin: 10px;
        }

        .controls {
          flex-direction: column;
          gap: 10px;
        }

        .column-toggle {
          flex-wrap: wrap;
          justify-content: center;
        }

        table {
          display: block;
          overflow-x: auto;
          white-space: nowrap;
        }

        th,
        td {
          padding: 8px;
          font-size: 14px;
        }

        .btn-view,
        .btn-delete {
          padding: 6px 8px;
          font-size: 12px;
        }

        /* Modal responsif */
        .modal-content {
          width: 95%;
          margin: 5% auto;
          padding: 10px;
          cursor: auto;
        }

        h1 {
          font-size: 24px;
          margin-bottom: 20px;
        }

        #editModal .modal-content {
          width: 90%;
          padding: 15px;
          margin: 20px auto;
        }

        .form-group label {
          font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
          font-size: 14px;
          padding: 6px;
        }

        .btn-save {
          padding: 8px 16px;
          font-size: 14px;
        }
      }

      .dropdown-content {
        right: auto;
        left: 0;
      }

      .action-btn {
        padding: 6px;
        font-size: 12px;
      }

      /* Untuk layar sangat kecil */
      @media screen and (max-width: 480px) {
        body {
          padding: 10px;
        }

        .dropdown {
          position: static; /* Ubah ke static untuk menghindari masalah positioning */
        }

        .dropdown-content {
          position: absolute;
          left: auto;
          right: 10px; /* Berikan jarak dari kanan */
          min-width: 120px; /* Kurangi lebar minimum */
          z-index: 1000; /* Tingkatkan z-index */
        }

        .action-btn {
          padding: 6px 12px; /* Tambah padding horizontal */
          font-size: 14px; /* Perbesar font sedikit */
          width: auto; /* Biarkan lebar menyesuaikan konten */
          white-space: nowrap; /* Hindari pemisahan teks */
          display: inline-block; /* Ubah display */
          background-color: #4caf50; /* Pastikan warna tetap terlihat */
          margin: 2px 0; /* Tambah margin vertikal */
        }

        .dropdown-content button {
          padding: 8px 12px; /* Sesuaikan padding */
          font-size: 14px; /* Sesuaikan ukuran font */
        }

        #editModal .modal-content {
          margin: 10px;
          padding: 15px;
          width: 90%;
        }

        #editModal h2 {
          font-size: 18px;
        }

        .form-group {
          margin-bottom: 10px;
        }

        .form-group label {
          font-size: 14px;
        }

        .form-group input,
        .form-group textarea {
          padding: 6px 10px;
        }

        .btn-save {
          padding: 8px 16px;
          font-size: 14px;
        }
      }
      .container {
        padding: 5px;
        margin: 5px;
      }

      h1 {
        font-size: 20px;
      }

      th,
      td {
        padding: 6px;
        font-size: 12px;
      }

      .column-toggle label {
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Dashboard Admin</h1>

      <div class="controls">
        <div class="column-toggle">
          <label>
            <input type="checkbox" data-column="ktp" checked /> Foto KTP
          </label>
          <label>
            <input type="checkbox" data-column="pasfoto" checked /> Pas Foto
          </label>
          <label>
            <input type="checkbox" data-column="tgl_lahir" checked /> Tanggal
            Lahir
          </label>
          <label>
            <input type="checkbox" data-column="alamat" checked /> Alamat
          </label>
          <label>
            <input type="checkbox" data-column="no_hp" checked /> No HP
          </label>
        </div>
      </div>

      <table id="dataTable">
        <thead>
          <tr>
            <th>Tanggal Input</th>
            <th>Nama</th>
            <th>NIK</th>
            <th class="col-ktp">Foto KTP</th>
            <th class="col-pasfoto">Pas Foto</th>
            <th class="col-tgl_lahir">Tanggal Lahir</th>
            <th class="col-alamat">Alamat</th>
            <th class="col-no_hp">No HP</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <!-- Modal untuk menampilkan gambar -->
    <div id="imageModal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <img id="imagePreview" />
      </div>
    </div>

    <!-- Modal untuk edit data -->
    <div id="editModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Edit Data</h2>
          <span class="close">&times;</span>
        </div>
        <form id="editForm">
          <div class="form-group">
            <label for="edit_nama">Nama:</label>
            <input type="text" id="edit_nama" required />
          </div>
          <div class="form-group">
            <label for="edit_nik">NIK:</label>
            <input type="text" id="edit_nik" required pattern="[0-9]{16}" />
          </div>
          <div class="form-group">
            <label for="edit_tgl_lahir">Tanggal Lahir:</label>
            <input type="date" id="edit_tgl_lahir" required />
          </div>
          <div class="form-group">
            <label for="edit_alamat">Alamat:</label>
            <textarea id="edit_alamat" required></textarea>
          </div>
          <div class="form-group">
            <label for="edit_no_hp">No HP:</label>
            <input type="tel" id="edit_no_hp" required pattern="[0-9]{10,13}" />
          </div>
          <button type="submit" class="btn-save">Simpan Perubahan</button>
        </form>
      </div>
    </div>

    <script>
      // Fungsi untuk memuat data dari Google Sheets
      async function loadData() {
        try {
          // Buat elemen script untuk JSONP
          const script = document.createElement("script");
          const callbackName =
            "jsonpCallback_" + Math.round(Math.random() * 1000000);

          // Definisikan callback function
          window[callbackName] = function (data) {
            if (Array.isArray(data)) {
              displayData(data);
            } else {
              console.error("Data bukan array:", data);
              displayData([]);
            }
            // Hapus script dan callback setelah selesai
            document.body.removeChild(script);
            delete window[callbackName];
          };

          // Set URL dengan callback
          script.src = `https://script.google.com/macros/s/AKfycbya8Z09YtFvREmGhRt0HrNYqTp8a1xBeOb1Mq_BLgkSrCcdfq4dXhIyGo61kigmdB1kWA/exec?action=getData&callback=${callbackName}`;

          // Tambahkan script ke body
          document.body.appendChild(script);

          // Handle error
          script.onerror = function () {
            console.error("Error loading data");
            alert("Gagal memuat data");
            displayData([]);
            document.body.removeChild(script);
            delete window[callbackName];
          };
        } catch (error) {
          console.error("Error:", error);
          alert("Gagal memuat data: " + error.message);
          displayData([]);
        }
      }

      // Fungsi untuk menampilkan data dalam tabel
      function displayData(data) {
        const tableBody = document.getElementById("tableBody");
        tableBody.innerHTML = "";

        data.forEach((row, index) => {
          // Format tanggal input dari DD-MM-YYYY
          const tglInput = row.tgl_input || "-";

          // Format tanggal lahir
          let tglLahir = "-";
          if (row.tgl_lahir) {
            // Hapus string 'undefined' jika ada
            const cleanDate = row.tgl_lahir.replace("undefined-", "");
            if (cleanDate.includes("-")) {
              const [year, month, day] = cleanDate.split("-");
              tglLahir = `${day}/${month}/${year}`;
            } else {
              tglLahir = cleanDate;
            }
          }

          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${tglInput}</td>
            <td>${row.nama}</td>
            <td>${row.nik}</td>
            <td class="col-ktp">
              ${
                row.foto_ktp
                  ? `<button class="btn-view" onclick="showImage('${row.foto_ktp}')">Lihat KTP</button>`
                  : "Tidak ada gambar"
              }
            </td>
            <td class="col-pasfoto">
              ${
                row.pas_foto
                  ? `<button class="btn-view" onclick="showImage('${row.pas_foto}')">Lihat Pas Foto</button>`
                  : "Tidak ada gambar"
              }
            </td>
            <td class="col-tgl_lahir">${tglLahir}</td>
            <td class="col-alamat">${row.alamat || "-"}</td>
            <td class="col-no_hp">${row.no_hp || "-"}</td>
            <td>
              <div class="dropdown">
                <button class="action-btn">action▼</button>
                <div class="dropdown-content">
                  <button onclick="editData(${index})">Edit</button>
                  <button onclick="deleteData(${index})">Hapus</button>
                </div>
              </div>
            </td>
          `;
          tableBody.appendChild(tr);
        });
      }

      // Fungsi untuk memformat tanggal dari YYYY-MM-DD ke DD-MM-YYYY
      function formatDate(dateStr) {
        if (!dateStr) return "-";
        const [year, month, day] = dateStr.split("-");
        return `${day}-${month}-${year}`;
      }

      // Fungsi untuk menampilkan gambar dalam modal
      function showImage(base64Image) {
        const modal = document.getElementById("imageModal");
        const preview = document.getElementById("imagePreview");

        if (!base64Image) {
          alert("Gambar tidak tersedia");
          return;
        }

        try {
          // Cek apakah data adalah URL gambar
          if (base64Image.startsWith("http")) {
            preview.src = base64Image;
          } else {
            // Jika data adalah base64
            const cleanedImage = base64Image.replace(
              /^data:image\/(png|jpeg|jpg);base64,/,
              ""
            );
            preview.src = `data:image/jpeg;base64,${cleanedImage}`;
          }
          modal.style.display = "block";
        } catch (error) {
          console.error("Error menampilkan gambar:", error);
          alert("Gagal menampilkan gambar");
        }
      }

      // Fungsi untuk menampilkan modal edit
      async function editData(index) {
        try {
          const script = document.createElement("script");
          const callbackName =
            "editCallback_" + Math.round(Math.random() * 1000000);

          window[callbackName] = function (response) {
            if (response.status === "success") {
              const data = response.data;
              document.getElementById("edit_nama").value = data.nama;
              document.getElementById("edit_nik").value = data.nik;
              document.getElementById("edit_tgl_lahir").value =
                formatDateForInput(data.tgl_lahir);
              document.getElementById("edit_alamat").value = data.alamat;
              document.getElementById("edit_no_hp").value = data.no_hp;

              const editModal = document.getElementById("editModal");
              editModal.style.display = "block";

              // Simpan index yang sedang diedit
              editModal.dataset.editIndex = index + 2; // Tambah 2 karena ada header dan index dimulai dari 0
            } else {
              alert("Gagal memuat data: " + response.message);
            }
            document.body.removeChild(script);
            delete window[callbackName];
          };

          script.src = `https://script.google.com/macros/s/AKfycbya8Z09YtFvREmGhRt0HrNYqTp8a1xBeOb1Mq_BLgkSrCcdfq4dXhIyGo61kigmdB1kWA/exec?action=editData&index=${
            index + 2
          }&callback=${callbackName}`;
          document.body.appendChild(script);
        } catch (error) {
          console.error("Error:", error);
          alert("Gagal memuat data untuk edit");
        }
      }

      // Fungsi untuk memformat tanggal untuk input date
      function formatDateForInput(dateStr) {
        const [day, month, year] = dateStr.split("/");
        return `${year}-${month.padStart(2, "0")}-${day.padStart(2, "0")}`;
      }

      // Event listener untuk form edit
      document
        .getElementById("editForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const editModal = document.getElementById("editModal");
          const index = parseInt(editModal.dataset.editIndex);

          try {
            const script = document.createElement("script");
            const callbackName =
              "saveEditCallback_" + Math.round(Math.random() * 1000000);

            window[callbackName] = function (response) {
              if (response.status === "success") {
                alert("Data berhasil diperbarui");
                editModal.style.display = "none";
                loadData(); // Muat ulang data
              } else {
                alert("Gagal memperbarui data: " + response.message);
              }
              document.body.removeChild(script);
              delete window[callbackName];
            };

            const formData = {
              action: "saveEdit", // Ubah action menjadi saveEdit
              index: index,
              nama: document.getElementById("edit_nama").value,
              nik: document.getElementById("edit_nik").value,
              tgl_lahir: document.getElementById("edit_tgl_lahir").value,
              alamat: document.getElementById("edit_alamat").value,
              no_hp: document.getElementById("edit_no_hp").value,
            };

            // Ubah URL dan parameter
            script.src = `https://script.google.com/macros/s/AKfycbya8Z09YtFvREmGhRt0HrNYqTp8a1xBeOb1Mq_BLgkSrCcdfq4dXhIyGo61kigmdB1kWA/exec?action=saveEdit&data=${encodeURIComponent(
              JSON.stringify(formData)
            )}&callback=${callbackName}`;
            document.body.appendChild(script);
          } catch (error) {
            console.error("Error:", error);
            alert("Gagal menyimpan perubahan");
          }
        });

      // Tutup modal edit
      document.querySelectorAll(".modal .close").forEach(function (closeBtn) {
        closeBtn.onclick = function () {
          this.closest(".modal").style.display = "none";
        };
      });

      // Fungsi untuk menghapus data
      async function deleteData(index) {
        if (confirm("Apakah Anda yakin ingin menghapus data ini?")) {
          try {
            // Buat elemen script untuk JSONP
            const script = document.createElement("script");
            const callbackName =
              "deleteCallback_" + Math.round(Math.random() * 1000000);

            // Definisikan callback function
            window[callbackName] = function (response) {
              if (response.status === "success") {
                alert("Data berhasil dihapus");
                loadData(); // Muat ulang data setelah menghapus
              } else {
                alert(
                  "Gagal menghapus data: " +
                    (response.message || "Terjadi kesalahan")
                );
              }
              // Hapus script dan callback setelah selesai
              document.body.removeChild(script);
              delete window[callbackName];
            };

            // Set URL dengan callback dan parameter
            // Tambahkan 2 karena ada baris header dan index dimulai dari 0
            const rowToDelete = index + 2;
            script.src = `https://script.google.com/macros/s/AKfycbya8Z09YtFvREmGhRt0HrNYqTp8a1xBeOb1Mq_BLgkSrCcdfq4dXhIyGo61kigmdB1kWA/exec?action=deleteData&index=${rowToDelete}&callback=${callbackName}`;

            // Tambahkan script ke body
            document.body.appendChild(script);

            // Handle error
            script.onerror = function () {
              alert("Gagal menghapus data: Terjadi kesalahan jaringan");
              document.body.removeChild(script);
              delete window[callbackName];
            };
          } catch (error) {
            console.error("Error:", error);
            alert("Gagal menghapus data: " + error.message);
          }
        }
      }

      // Tambahkan event listener untuk menutup modal saat klik di luar
      window.onclick = function (event) {
        const editModal = document.getElementById("editModal");
        const imageModal = document.getElementById("imageModal");

        if (event.target === editModal) {
          editModal.style.display = "none";
        }
        if (event.target === imageModal) {
          imageModal.style.display = "none";
        }
      };

      // Menutup modal
      document.querySelector(".close").onclick = function () {
        document.getElementById("imageModal").style.display = "none";
      };

      // Toggle kolom
      document.querySelectorAll(".column-toggle input").forEach((checkbox) => {
        checkbox.addEventListener("change", function () {
          const column = this.dataset.column;
          const cells = document.querySelectorAll(`.col-${column}`);
          cells.forEach((cell) => {
            cell.style.display = this.checked ? "" : "none";
          });
        });
      });

      // Muat data saat halaman dimuat
      loadData();
    </script>
  </body>
</html>
